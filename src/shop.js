export const chars = [
  { name: 'lonely prince', level: 2, count: 15, tags: ['good', 'prince'] },
  {
    name: 'sherwood sureshot',
    level: 2,
    count: 15,
    tags: ['good', 'princess', 'ranged'],
  },
  {
    name: 'cinderella',
    level: 2,
    count: 15,
    quest: true,
    tags: ['princess', 'mage'],
  },
  { name: 'billy gruff', level: 2, count: 15, tags: ['evil', 'animal'] },
  { name: 'baby dragon', level: 2, count: 15, tags: ['dragon', 'flying'] },
  {
    name: 'baby root',
    level: 2,
    count: 15,
    tags: ['good', 'treant', 'support'],
  },
  {
    name: 'black cat',
    level: 2,
    count: 15,
    tags: ['evil', 'animal', 'last breath'],
  },
  { name: 'blind mouse', level: 2, count: 15, tags: ['animal'] },
  { name: 'crafty', level: 2, count: 15, tags: ['dwarf'] },
  { name: 'fanny', level: 2, count: 15, tags: ['dwarf', 'support'] },
  { name: 'golden chicken', level: 2, count: 15, tags: ['animal'] },
  { name: 'happy little tree', level: 2, count: 15, tags: ['good', 'treant'] },
  { name: 'humpty dumpty', level: 2, count: 15, tags: ['good', 'egg'] },
  {
    name: 'kitty cutpurse',
    level: 2,
    count: 15,
    tags: ['evil', 'animal', 'slay'],
  },
  {
    name: 'labryinth minotaur',
    level: 2,
    count: 15,
    tags: ['evil', 'monster'],
  },
  {
    name: 'mad mim',
    level: 2,
    count: 15,
    tags: ['evil', 'mage', 'support'],
  },
  {
    name: 'polywoggle',
    level: 2,
    count: 15,
    tags: ['animal', 'slay'],
  },
  {
    name: 'rainbow unicorn',
    level: 2,
    count: 15,
    tags: ['good', 'animal'],
  },
  {
    name: 'tiny',
    level: 2,
    count: 15,
    tags: ['dwarf'],
  },
  {
    name: `wizard's familiar`,
    level: 2,
    count: 15,
    tags: ['animal', 'mage'],
  },
  {
    name: 'brave princess',
    level: 3,
    count: 15,
    quest: true,
    tags: ['good', 'princess', 'slay'],
  },
  { name: 'darkwood creeper', level: 3, count: 15, tags: ['evil', 'treant'] },
  { name: 'dubly', level: 3, count: 15, tags: ['dwarf'] },
  {
    name: 'good witch',
    level: 3,
    count: 15,
    tags: ['good', 'support', 'mage'],
  },
  { name: 'lucky', level: 3, count: 15, tags: ['dwarf', 'last breath'] },
  {
    name: 'ogre princess',
    level: 3,
    count: 15,
    tags: ['monster', 'good', 'princess', 'slay'],
  },
  {
    name: 'princess peep',
    level: 3,
    count: 15,
    tags: ['last breath', 'princess', 'good'],
  },
  {
    name: 'princess wight',
    level: 3,
    count: 15,
    quest: true,
    tags: ['evil', 'princess'],
  },
  { name: 'prized pig', level: 3, count: 15, tags: ['animal', 'last breath'] },
  { name: 'queen of hearts', level: 3, count: 15, tags: ['evil', 'queen'] },
  {
    name: 'romeo',
    level: 3,
    count: 15,
    tags: ['good', 'prince', 'last breath'],
  },
  {
    name: 'shadow assassin',
    level: 3,
    count: 15,
    tags: ['evil', 'monster', 'ranged'],
  },
  {
    name: 'sleeping princess',
    level: 3,
    count: 15,
    tags: ['good', 'princess'],
  },
  {
    name: 'spell weaver',
    level: 3,
    count: 15,
    tags: ['evil', 'mage', 'ranged'],
  },
  { name: 'the white stag', level: 3, count: 15, tags: ['good', 'animal'] },
  { name: 'trojan donkey', level: 3, count: 15, tags: ['good', 'animal'] },
  { name: 'vain-pire', level: 3, count: 15, tags: ['evil', 'monster', 'slay'] },
  {
    name: 'wicked witch',
    level: 3,
    count: 15,
    tags: ['evil', 'support', 'mage'],
  },
  {
    name: 'wretched mummy',
    level: 3,
    count: 15,
    tags: ['evil', 'monster', 'last breath'],
  },
  { name: 'bearded vulture', level: 4, count: 15, tags: ['evil', 'animal'] },
  { name: 'copycat', level: 4, count: 15, tags: ['animal'] },
  {
    name: 'court wizard',
    level: 4,
    count: 15,
    tags: ['mage', 'good', 'ranged'],
  },
  { name: 'fairy godmother', level: 4, count: 15, tags: ['good', 'fairy'] },
  {
    name: 'friendly spirit',
    level: 4,
    count: 15,
    tags: ['good', 'monster', 'last breath'],
  },
  { name: 'greedy', level: 4, count: 15, tags: ['dwarf'] },
  { name: 'grim soul', level: 4, count: 15, tags: ['monster', 'last breath'] },
  {
    name: 'heartwood elder',
    level: 4,
    count: 15,
    tags: ['good', 'treant', 'support'],
  },
  {
    name: 'hungry hungry hippocampus',
    level: 4,
    count: 15,
    tags: ['good', 'animal'],
  },
  { name: 'juliet', level: 4, count: 15, tags: ['good', 'princess'] },
  {
    name: 'lady of the lake',
    level: 4,
    count: 15,
    tags: ['good', 'mage', 'support', 'ranged'],
  },
  { name: 'lightning dragon', level: 4, count: 15, tags: ['dragon', 'flying'] },
  { name: 'medusa', level: 4, count: 15, tags: ['evil', 'monster'] },
  {
    name: 'monster book',
    level: 4,
    count: 15,
    tags: ['evil', 'monster', 'last breath'],
  },
  { name: 'prince arthur', level: 4, count: 15, tags: ['good', 'prince'] },
  {
    name: 'puff puff',
    level: 4,
    count: 15,
    tags: ['good', 'puff puff', 'last breath'],
  },
  {
    name: 'riverwish mermaid',
    level: 4,
    count: 15,
    tags: ['good', 'princess', 'support'],
  },
  {
    name: `sheep in wolf's clothing`,
    level: 4,
    count: 15,
    tags: ['evil', 'animal', 'last breath'],
  },
  {
    name: 'soltak ancient',
    level: 4,
    count: 15,
    tags: ['good', 'treant'],
  },
  {
    name: 'sporko',
    level: 4,
    count: 15,
    tags: ['evil', 'mage', 'support', 'ranged'],
  },
  {
    name: 'the chupacabra',
    level: 4,
    count: 15,
    tags: ['evil', 'monster', 'slay'],
  },
  {
    name: 'the nutcracker',
    level: 4,
    count: 15,
    quest: true,
    tags: ['good', 'prince', 'treant'],
  },
  { name: 'tweedle dee', level: 4, count: 15, tags: ['dwarf', 'last breath'] },
  { name: 'angry', level: 5, count: 15, tags: ['dwarf'] },
  { name: 'aon', level: 5, count: 15, tags: ['evil', 'mage', 'slay'] },
  {
    name: 'baba yaga',
    level: 5,
    count: 15,
    tags: ['evil', 'monster', 'support'],
  },
  {
    name: 'baby bear',
    level: 5,
    count: 15,
    tags: ['good', 'animal', 'last breath'],
  },
  {
    name: 'cupid',
    level: 5,
    count: 15,
    tags: ['good', 'fairy', 'flying', 'ranged'],
  },
  {
    name: 'lancelot',
    level: 5,
    count: 15,
    quest: true,
    tags: ['good', 'prince', 'slay'],
  },
  { name: 'nian', level: 5, count: 15, tags: ['evil', 'monster'] },
  { name: 'rotten applewood', level: 5, count: 15, tags: ['evil', 'treant'] },
  { name: 'shoulder faeries', level: 5, count: 15, tags: ['fairy'] },
  {
    name: 'southern siren',
    level: 5,
    count: 15,
    tags: ['evil', 'monster', 'slay'],
  },
  {
    name: 'wombats in disguise',
    level: 5,
    count: 15,
    tags: ['animal', 'last breath'],
  },
  { name: 'ashwood elm', level: 6, count: 10, tags: ['evil', 'treant'] },
  { name: 'bearstein', level: 6, count: 10, tags: ['good', 'animal'] },
  { name: 'doombreath', level: 6, count: 10, tags: ['evil', 'dragon'] },
  { name: 'echowood', level: 6, count: 10, tags: ['treant'] },
  {
    name: 'good boy',
    level: 6,
    count: 10,
    tags: ['good', 'animal', 'last breath'],
  },
  {
    name: 'great pumpkin king',
    level: 6,
    count: 10,
    tags: ['evil', 'monster', 'last breath'],
  },
  {
    name: 'grumblegore',
    level: 6,
    count: 10,
    tags: ['evil', 'monster', 'support', 'ranged'],
  },
  {
    name: 'hercules',
    level: 6,
    count: 10,
    quest: true,
    tags: ['good', 'prince'],
  },
  { name: 'jormungand', level: 6, count: 10, tags: ['monster', 'slay'] },
  { name: 'lordy', level: 6, count: 10, tags: ['dwarf'] },
  { name: 'oni king', level: 6, count: 10, tags: ['evil', 'monster'] },
  {
    name: 'robinwood',
    level: 6,
    count: 10,
    tags: ['good', 'treant', 'ranged'],
  },
  {
    name: 'the green knight',
    level: 6,
    count: 10,
    tags: ['good', 'treant', 'support'],
  },
  { name: 'the storm king', level: 6, count: 10, tags: ['mage'] },
  {
    name: 'three big pigs',
    level: 6,
    count: 10,
    tags: ['evil', 'animal', 'last breath'],
  },
]

export const tags = chars.reduce(
  (acc, char) => [...new Set([...acc, ...char.tags])],
  [],
)

const transformedChars = chars.reduce(
  (acc, { name, ...char }) => ({ ...acc, [name]: char }),
  {},
)
// console.log(chars.length)

export function drawHand({ handSize, level = 2, deadCards = [] }) {
  const leftCards = deadCards.reduce(
    (acc, card) => {
      const d = transformedChars[card.name]
      return {
        ...acc,
        [card.name]: { ...d, count: d.quest ? 0 : d.count - card.count },
      }
    },
    { ...transformedChars },
  )
  var deck = Object.entries(leftCards).flatMap(
    ([name, { count, ...char }]) =>
      char.level <= level ? new Array(count).fill({ name, ...char }) : [],
    [],
  )
  // todo: refrain from mutating deck
  const hand = new Array(handSize).fill({}).map(() => {
    const card = deck[Math.floor(Math.random() * deck.length)]
    if (card.quest) deck = deck.filter(({ name }) => name !== card.name)
    return card
  })
  return hand
}

const findSomething = (predicate) =>
  function* ({ handSize, level, deadCards, iterations = 10 }) {
    var target = 0
    for (let i = 0; i < iterations; i++) {
      const hand = drawHand({ handSize, level, deadCards })
      target += predicate(hand) ? 1 : 0
      if ((i + 1) % 1000 === 0)
        yield {
          prob: target / (i + 1),
          progress: Math.floor((100 * i) / iterations),
        }
    }
    return { prob: target / iterations, progress: 100 }
  }

export const findCard = (cardName) =>
  findSomething((hand) => hand.some((card) => card.name === cardName))
export const findCards = (cards) =>
  findSomething((hand) => hand.some((card) => cards.includes(card.name)))
// const findFrogs = findCard('lonely prince')
// console.log(findFrogs({ handSize: 4, level: 3 }))
// console.log(findFrogs({ handSize: 3 }))
// console.log(
//   findCard('cinderella')({
//     handSize: 3,
//     deadCards: [{ name: 'cinderella', count: 3 }],
//   }),
// )
// console.log(findFrogs(4))
// console.log(findCard('cinderella')(3))

export const findTag = (tag) =>
  findSomething((hand) => hand.find((card) => card.tags.includes(tag)))

// const findGood = findTag('good')
// console.log(findGood(3))
// console.log(findGood(4))

// const findAnimal = findTag('animal')
// console.log(findAnimal(3))
// console.log(findAnimal(4))

// Turn 1-2: 3 card shops
// turn 3-6: 4 card shops
// turn 7+: 5 card shops
